'use strict';

var respondToInvalidSessionToken = require('./respond-to-invalid-session-token.js');
var getShopFromRequest = require('./get-shop-from-request.js');

async function validateSessionToken(params, request, token, { checkAudience = true } = {}) {
    const { api, logger } = params;
    logger.debug('Validating session token', { shop: getShopFromRequest.getShopFromRequest(request) });
    try {
        const payload = await api.session.decodeSessionToken(token, {
            checkAudience,
        });
        const dest = new URL(payload.dest);
        const shop = dest.hostname;
        logger.debug('Session token is valid - validated', {
            shop,
            payload: JSON.stringify(payload),
        });
        return payload;
    }
    catch (error) {
        logger.debug(`Failed to validate session token: ${error.message}`, {
            shop: getShopFromRequest.getShopFromRequest(request),
        });
        throw respondToInvalidSessionToken.respondToInvalidSessionToken({ params, request, retryRequest: true });
    }
}

exports.validateSessionToken = validateSessionToken;
//# sourceMappingURL=validate-session-token.js.map
